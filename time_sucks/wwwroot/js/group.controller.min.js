angular.module("time").controller("GroupCtrl",["$scope","$http","$routeParams","$location","usSpinnerService",function(n,t,i,r){n.loaded=!1;n.group={};n.group.users={};n.load=function(){var u,f,e;n.groupID=i.ID;n.groupID||r.path("/courses");t.post("/Home/GetGroup",n.groupID).then(function(t){n.group=t.data},function(){toastr.error("Failed to get group.")});$.each(n.group.users,function(t){n.group.users[t].blank={timeID:t+"-blank",hours:"",isEdited:!1,timeIn:"",timeOut:"",desc:""}});n.createTime=function(t,i=""){var r={userID:t,groupID:n.groupID};n.group.users[t].time[n.newNumber]={timeID:n.newNumber,hours:"",isEdited:!1,timeIn:i,timeOut:"",desc:""};n.newNumber++;toastr.info("Create time for user: "+t)};n.createTimeFromBlank=function(t){var i={userID:t,groupID:n.groupID};(n.group.users[t].blank.timeIn!==""||n.group.users[t].blank.timeOut!==""||n.group.users[t].blank.desc!=="")&&(n.group.users[t].time[n.newNumber]={timeID:n.newNumber,hours:"",isEdited:!1,timeIn:n.group.users[t].blank.timeIn,timeOut:n.group.users[t].blank.timeOut,desc:n.group.users[t].blank.desc},n.newNumber++,n.group.users[t].blank.timeIn="",n.group.users[t].blank.timeOut="",n.group.users[t].blank.desc="",toastr.info("Create time for user: "+t))};n.leaveGroup=function(){confirm("Are you sure you want to leave this group?")&&(n.group.users[n.$parent.user.userID].isActive=!1,toastr.info("Attempted to leave group - enable REST endpoint."))};n.joinGroup=function(){n.group.users[n.$parent.user.userID]={userID:n.$parent.user.userID,firstName:n.$parent.user.firstName,lastName:n.$parent.user.lastName,isActive:!0,time:{}};toastr.info("Attempted to leave group - enable REST endpoint.")};n.saveGroup=function(){toastr.info("Attempted to save group - enable REST endpoint");n.updateChart()};n.userInGroup=function(){if(!n.$parent.user)return!1;var t=!1;return n.group?($.each(n.group.users,function(i,r){Number(r.userID)===Number(n.$parent.user.userID)&&(t=!0)}),t):!1};n.hasUnfinishedBusiness=function(){var t=!1;return n.userInGroup()&&$.each(n.group.users[n.$parent.user.userID].time,function(n,i){i.timeIn!==""&&i.timeOut===""&&(t=!0)}),t};n.startTime=function(){n.userInGroup()?n.createTime(n.$parent.user.userID,moment().format("MM/DD/YYYY h:mm A")):toastr.error("The logged in user isn't a member of the group.")};n.endTime=function(){n.userInGroup()?$.each(n.group.users[n.$parent.user.userID].time,function(t,i){if(i.timeIn!==""&&i.timeOut==="")return n.group.users[n.$parent.user.userID].time[i.timeID].timeOut=moment().format("MM/DD/YYYY h:mm A"),n.group.users[n.$parent.user.userID].time[i.timeID].hours=moment.duration(moment(n.group.users[n.$parent.user.userID].time[i.timeID].timeOut).diff(n.group.users[n.$parent.user.userID].time[i.timeID].timeIn)).asHours().toFixed(2),!1}):toastr.error("The logged in user isn't a member of the group.")};n.saveTime=function(t,i){n.group.users[t].time[i].hours=n.group.users[t].time[i].timeIn===""||n.group.users[t].time[i].timeOut===""?0:moment.duration(moment(n.group.users[t].time[i].timeOut).diff(n.group.users[t].time[i].timeIn)).asHours().toFixed(2);n.updateChart()};n.diffHours=function(n,t){return n===""||t===""?"0.00":moment.duration(moment(t).diff(n)).asHours().toFixed(2)};n.formatTime=function(){};n.isUser=function(t){return n.$parent.user?t===n.$parent.user.userID||n.$parent.user.type==="A":!1};n.updateAllHours=function(){$.each(n.group.users,function(t,i){$.each(i.time,function(t,r){r.timeIn!==""&&r.timeOut!==""&&(n.group.users[i.userID].time[r.timeID].hours=moment.duration(moment(n.group.users[i.userID].time[r.timeID].timeOut).diff(n.group.users[i.userID].time[r.timeID].timeIn)).asHours().toFixed(2))})})};u={datasets:[{data:[],backgroundColor:["#2C3E50","#3498DB","#18BC9C","#F39C12","#e83e8c","#6610f2","#fd7e14","#E74C3C","#6f42c1","#95a5a6","#2C3E50","#3498DB","#18BC9C","#F39C12","#e83e8c","#6610f2","#fd7e14","#E74C3C","#6f42c1","#95a5a6","#2C3E50","#3498DB","#18BC9C","#F39C12","#e83e8c","#6610f2","#fd7e14","#E74C3C","#6f42c1","#95a5a6"]}],labels:[]};n.setData=function(){var t,r,i;u.datasets[0].data=[];u.labels=[];for(t in n.group.users){t=n.group.users[t];r=0;for(i in t.time)i=t.time[i],r+=Number(i.hours);u.datasets[0].data.push(r);u.labels.push(t.firstName+" "+t.lastName)}};n.setData();f=$("#groupHours");e=new Chart(f,{type:"pie",data:u});n.updateChart=function(){n.setData();e.update()};n.updateAllHours();n.updateChart();n.loaded=!0};n.$parent.user&&n.$parent.user!==""?n.load():t.get("/Home/CheckSession").then(function(t){n.$parent.user=t.data;n.$parent.loaded=!0;n.load()},function(){toastr.error("Not logged in.");r.path("/login")})}]);